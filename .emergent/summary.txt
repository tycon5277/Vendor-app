<analysis>**original_problem_statement:**
The user's initial request was to fix a series of critical navigation and UI bugs in their React Native Vendor App. After resolving these, the focus shifted dramatically to a major architectural and feature enhancement project. The goal is to transform the Vendor App's backend into a centralized API service for a separate Wisher App, mimicking the architecture of platforms like Zomato/Swiggy. This includes implementing a multi-vendor ordering system and a sophisticated delivery assignment flow using a Carpet Genie app.

**PRODUCT REQUIREMENTS:**
1.  **API Hub (P0):** The Vendor App backend must provide a complete and robust set of APIs for the Wisher App to handle vendors, products, cart management, and ordering.
2.  **Order Modification Flow (P0):** Vendors must be able to view orders from the Wisher App, modify them, and process partial refunds.
3.  **Advanced Delivery (P0):** Implement a sophisticated delivery assignment flow involving Carpet Genies. This includes auto-assignment, manual requests, real-time tracking, and a secure pickup process.
4.  **Multi-Order Feature (P0):** A Wisher must be able to order from multiple vendors in a single checkout. (Note: User has currently requested to hide this feature in the Wisher App UI).
5.  **UI for New Features (P0):** The Vendor App frontend needs dedicated UI sections to manage Wisher App orders, including live delivery status and QR codes for pickup.

**User's preferred language**: English

**what currently exists?**
The project is a full-stack application with a React Native (Expo) frontend for the Vendor App and a monolithic FastAPI backend using MongoDB.

-   **Backend**: A comprehensive delivery assignment system is in place. It automatically broadcasts delivery requests to nearby Carpet Genies when an order is being prepared. It includes an infinite retry mechanism with expanding search radius and increasing fees. The backend has been optimized to fix N+1 query issues and includes database indexes for performance. A secure, JWT-based QR code generation and verification system has been implemented on the backend for order pickups.
-   **Frontend (Vendor App)**: The UI can display live Genie status (e.g., Searching..., Assigned to...). Numerous navigation and UI bugs have been fixed, including issues with web logout and Expo Router hook usage. A cleanup function was added to reset all vendor and order data.
-   **Integrations**: The system is designed to integrate with a Wisher App (for customers) and a Carpet Genie App (for delivery partners), providing all necessary APIs for them to function. The agent has been providing instructions and corrected URLs to the user for these external apps.

**Last working item**:
-   **Last item agent was working:** The agent had just completed the backend implementation for a secure QR code pickup verification system. The user pointed out that the agent, being the Vendor App, should also implement the frontend UI to display this QR code, which the agent had mistakenly provided as a prompt for the user. The agent acknowledged this and was about to start the frontend implementation.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N (Backend was tested via , but frontend UI is not implemented)
-   **Which testing method agent to use?**  to verify the QR code UI on the order detail screen after implementation.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Expo/ngrok Tunnel Unstable (P1)**
    -   **Description:** The Expo Go mobile app preview is frequently unavailable due to ngrok tunnel connectivity issues (). This is a recurring infrastructure problem that blocks mobile testing.
    -   **Attempted fixes:** Restarting the frontend service multiple times. The issue appears to be with the ngrok service itself, not the application code.
    -   **Next debug checklist:** This is likely an environmental issue. The agent should inform the user that this may be out of its control but can try another frontend: ERROR (no such process)
frontend: ERROR (no such process). If it persists, focus on web testing if possible.
    -   **Why fix this issue?** It's a major blocker for the user testing the mobile app experience.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
-   **Issue 2: Expo Router Navigation Errors (P1)**
    -   **Description:** The app has crashed multiple times with errors related to React Navigation hooks (, ) being called outside of a navigation context.
    -   **Attempted fixes:** The agent has fixed this in several files (, , ) by replacing imports from  with 's equivalent and ensuring hooks are used correctly.
    -   **Next debug checklist:** The agent should be vigilant for this error on any new or modified screens and proactively use  hooks only. A global search for  or  from  might be prudent.
    -   **Why fix this issue?** These are app-breaking crashes that ruin the user experience.
    -   **Status:** TESTING PENDING (Fixes were applied, but the issue has recurred on different screens).
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
-   **Issue 3: Web Logout Not Clearing Session (P2)**
    -   **Description:** The user reported that the logout button in the web view does not work correctly, leaving them logged into an old session.
    -   **Attempted fixes:** The agent modified  to explicitly clear  for the web platform, in addition to .
    -   **Next debug checklist:** Verify if the user can now log out successfully on the web. A hard refresh () was suggested as a temporary workaround.
    -   **Why fix this issue?** Basic authentication functionality is broken on the web.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend

**In progress Task List**:
-   **Task 1: Implement Vendor App UI for QR Code Pickup (P0)**
    -   **Where to resume:** Modify .
    -   **Plan:**
        1.  When an order's status is  and a Genie is assigned, call the new endpoint: .
        2.  Use the  from the API response to render a QR code on the screen using a library like .
        3.  Display the 6-digit  as a fallback option for the Genie.
        4.  Display the list of items in the order for the vendor to double-check.
    -   **What will be achieved with this?** This will complete the secure pickup verification feature, ensuring the correct Genie picks up the correct order.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Implement Fee Calculation Algorithm:** Build the logic for calculating the Carpet Genie delivery fee based on distance, time, etc.
-   **Future Tasks:**
    -   **(P1) Wisher App Multi-Order UI:** User asked to hide this for now, but the feature is a core requirement.
    -   **(P2) Implement Vendor Verification Workflow.**
    -   **(P2) Enhance the  Feature in the Vendor App.**
    -   **(P2) Refactor the monolithic  file** into modular route files.
    -   **(P2) Migrate chat to a dedicated service** like Firebase for production scalability.
    -   **(P2) Implement masked phone calls** via a service like Twilio for production.

**Completed work in this session**
-   **Live Genie Status & Profile:**
    -   Enhanced Vendor App UI to show live Carpet Genie status (, ).
    -   Enhanced Wisher App tracking API to include Genie's profile details (photo, rating) and live location.
-   **Robust Delivery Assignment:**
    -   Implemented an infinite retry logic for Genie assignment if no one accepts an order.
    -   Added an option for vendors *with* their own delivery service to manually request a Carpet Genie.
    -   Configured retry radius expansion and fee increase, with a max radius cap of 7km as per user request.
-   **Secure QR Code Pickup:**
    -   Implemented the full backend system for a secure JWT-based QR code and 6-digit OTP for pickup verification.
    -   Created endpoints for the Vendor App to generate QR data and for the Genie App to verify it.
-   **Performance Optimization:**
    -   Fixed critical N+1 query problems in the cart and order creation endpoints.
    -   Added database indexes to , , and  collections to speed up queries.
-   **Bug Fixes & Maintenance:**
    -   Resolved multiple Expo Router navigation crashes by standardizing on  hooks.
    -   Fixed the web logout functionality.
    -   Corrected a bug preventing Genies from accepting orders with  status.
    -   Fixed the Genie  endpoint to correctly show pending requests.
    -   Added an admin endpoint () to delete all vendor/product/order data for a clean slate.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: OTP Input Flakiness:** Noted in the initial handoff, the OTP input component in the web environment remains unaddressed.

**Known issue recurrence from previous fork**
-   None from the previous fork, but within this session, the **Expo/ngrok tunnel instability** and **Expo Router navigation context errors** have been highly recurrent.

**Code Architecture**


**Key Technical Concepts**
-   **Service-Oriented Architecture:** Backend serves Vendor, Wisher, and Genie apps.
-   **Real-time Communication:** Expo Push Notifications for delivery requests.
-   **REST API Design:** FastAPI with Pydantic models.
-   **Database Optimization:** N+1 query prevention, manual index creation.
-   **Secure Handover:** JWT-based temporary tokens embedded in QR codes for pickup verification.
-   **React Native (Expo) & Expo Router:** Frontend framework with file-based routing.

**key DB schema**
-   **users:** Vendor and Genie profiles.
-   **wisher_orders:** Contains , , and now fields for pickup verification (, ).
-   **genie_profiles:** Stores Genie data, including  and .
-   **genie_delivery_requests:** Tracks broadcasted delivery requests.
-   **hub_vendors:** Stores vendor shop data, including  (GeoJSON).
-   **hub_products:** Stores product data.

**changes in tech stack**
-   None.

**All files of reference**
-   **/app/backend/server.py**: Heavily modified with performance optimizations, infinite retry logic, and the complete secure QR code pickup verification system.
-   **/app/frontend/app/(main)/order-detail.tsx**: Modified to show Genie status; now needs the QR code UI.
-   **/app/frontend/app/(main)/(tabs)/home.tsx**: Fixed navigation context errors.
-   **/app/frontend/app/(main)/(tabs)/orders.tsx**: Fixed navigation context errors.
-   **/app/frontend/app/_layout.tsx**: Fixed to prevent root navigation context errors.
-   **/app/frontend/src/utils/authStore.ts**: Modified to fix web logout.

**Areas that need refactoring**:
-   The  file is critically monolithic and urgently needs to be broken down into smaller, domain-specific modules (e.g., , , ). This is a major technical debt.

**key api endpoints**
-   : **(New)** For Vendor App to get QR data.
-   : **(New)** For Genie to get item list for verification.
-   : **(New)** For Genie App to verify pickup via QR/OTP.
-   : Endpoint to manually trigger a retry for Genie search.
-   : Enhanced to include live Genie location from the moment of acceptance.
-   : **(New)** Admin endpoint to delete all transactional data.
-   : **(New)** Admin endpoint to bulk-update vendor coordinates.

**Critical Info for New Agent**
-   You are the **Vendor App**. The user manages two other apps (Wisher, Genie) and will paste instructions/errors from them. Your job is to support your part of the ecosystem and provide clear instructions for the other apps. Do not get confused about your role.
-   The last task was to implement the **Vendor App UI for the QR code system**. The backend is done, but the frontend part is pending. This is your highest priority.
-   The **Expo/ngrok tunnel is very unreliable**. Be prepared for the user to have trouble testing on their mobile device.
-   The backend API URL for other apps to use is . The user's other apps have frequently used incorrect/old URLs.
-   Authentication for Genies with the Vendor API is via the same Phone/OTP flow as any other user. The Genie app must get a session token and use it as a Bearer token.

**documents and test reports created in this job**
-    (updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Asks for live Genie location tracking for the Wisher App. **Status: COMPLETED** (Agent enhanced the tracking API and provided instructions).
2.  **User:** Proposes a QR code scanning system for pickup verification. **Status: COMPLETED** (Agent agreed and suggested enhancements).
3.  **User:** Confirms requirements for the QR system (mandatory checklist, OTP fallback). **Status: COMPLETED**.
4.  **User:** Points out that the agent, being the Vendor App, should implement the QR UI itself, not just provide a prompt. **Status: PENDING** (This is the current task).
5.  **User:** Asks for unlimited retries for Genie search and reports an error. **Status: COMPLETED** (Agent implemented unlimited retries and identified the user's error was a session timeout).
6.  **User:** Reports web logout is not working. **Status: COMPLETED** (Agent implemented a fix).
7.  **User:** Reports Genie is getting an error when accepting an order. **Status: COMPLETED** (Agent fixed a status mismatch bug on the backend).
8.  **User:** Reports the order is now visible but still fails to be accepted. **Status: ADDRESSED** (Agent confirmed the backend is working and the issue is in the Genie App's response handling, providing correct response format).
9.  **User:** Asks to delete all old orders. **Status: COMPLETED**.
10. **User:** Can't see today's order in the order tab. **Status: ADDRESSED** (Agent clarified the user needs to log in with the correct vendor account).

**Project Health Check:**
-   **Broken:**
    -   The Vendor App is missing the UI to display the order pickup QR code.
    -   The Expo/ngrok mobile preview tunnel is frequently down, blocking mobile testing.
-   **Mocked:**
    -   None.

**3rd Party Integrations**
-   **Expo / React Native:** Frontend framework.
-   **FastAPI:** Backend framework.
-   **MongoDB:** Database.
-   **Expo Push Notifications:** Used for real-time delivery requests.
-   **PyJWT**: Used for the secure QR code generation.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** Navigation context errors have appeared multiple times after being fixed on other screens.

**Credentials to test flow:**
-   **Vendor (Grocery Shop):** phone: , OTP: 
-   **Vendor (Meat shop):** phone: , OTP: 
-   **Vendor (Fruits shop):** phone: , OTP: 
-   **Wisher User:** phone: , OTP: 
-   **Carpet Genie:** phone: , OTP:  (Same user as Wisher)

**What agent forgot to execute**
-   The agent forgot its primary role as the Vendor App developer and provided a prompt for implementing the Vendor App UI instead of implementing it directly. The user corrected this, and it is now the immediate pending task.</analysis>
